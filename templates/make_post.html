{% extends 'base.html' %}
{% block title %}Create Post - BlogSpace{% endblock %}

{% block head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<style>
    /* Pure Black & White Color Scheme - Matching Homepage */
    :root {
        --white: #ffffff;
        --black: #000000;
        --light-gray: #f8f9fa;
        --medium-gray: #6c757d;
        --dark-gray: #495057;
        --border-color: #e9ecef;
        --accent: #2563eb;
        --accent-light: #dbeafe;
        --success: #10b981;
        --error: #ef4444;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        margin: 0;
        padding: 0;
        background: var(--white);
        overflow-x: hidden;
        scroll-behavior: smooth;
    }

    /* Top Navigation - Matching Homepage */
    .top-navbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: var(--white);
        border-bottom: 1px solid var(--border-color);
        z-index: 1000;
        height: 60px;
        width: 100%;
        box-sizing: border-box;
    }

    .nav-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 60px;
        width: 100%;
        box-sizing: border-box;
    }

    .logo {
        font-family: 'Playfair Display', serif;
        font-weight: 700;
        font-size: 1.5rem;
        color: var(--black);
        text-decoration: none;
    }

    .nav-links {
        display: flex;
        gap: 2rem;
    }

    .nav-link {
        color: var(--medium-gray);
        text-decoration: none;
        font-weight: 500;
        transition: color 0.3s ease;
    }

    .nav-link:hover {
        color: var(--black);
    }

    /* Create Post Container */
    .create-post-container {
        max-width: 800px;
        margin: 80px auto 2rem;
        padding: 0 1rem;
        width: 100%;
        box-sizing: border-box;
    }

    .page-header {
        margin-bottom: 2rem;
        text-align: center;
    }

    .page-title {
        font-family: 'Playfair Display', serif;
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--black);
        margin: 0 0 0.5rem 0;
    }

    .page-subtitle {
        color: var(--medium-gray);
        font-size: 1.1rem;
        margin: 0;
    }

    /* Post Form */
    .post-form {
        background: var(--white);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.05);
    }

    .form-group {
        margin-bottom: 2rem;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: var(--black);
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    .required::after {
        content: '*';
        color: #ef4444;
        margin-left: 4px;
    }

    .form-control {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        background: var(--white);
        transition: all 0.2s ease;
        box-sizing: border-box;
        font-family: 'Inter', sans-serif;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-light);
    }

    textarea.form-control {
        resize: vertical;
        min-height: 120px;
        line-height: 1.5;
    }

    textarea.form-control.large {
        min-height: 300px;
    }

    .help-text {
        font-size: 0.85rem;
        color: var(--medium-gray);
        margin-top: 0.5rem;
        line-height: 1.4;
    }

    .char-count {
        text-align: right;
        font-size: 0.8rem;
        color: var(--medium-gray);
        margin-top: 0.25rem;
    }

    /* Enhanced Tags Input */
    .tags-input-container {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 0.75rem;
        background: var(--white);
        min-height: 52px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
        cursor: text;
    }

    .tags-input-container:focus-within {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-light);
    }

    .tags-display {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        flex: 1;
    }

    .tag-item {
        background: var(--accent-light);
        color: var(--accent);
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        animation: slideIn 0.2s ease;
        border: 1px solid var(--accent-light);
    }

    .tag-remove {
        background: none;
        border: none;
        color: var(--accent);
        cursor: pointer;
        padding: 0;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        transition: all 0.2s ease;
    }

    .tag-remove:hover {
        background: var(--accent);
        color: white;
    }

    #postTagsInput {
        border: none;
        outline: none;
        flex: 1;
        min-width: 120px;
        padding: 0.5rem 0;
        background: transparent;
        font-size: 1rem;
        font-family: 'Inter', sans-serif;
    }

    #postTagsInput::placeholder {
        color: var(--medium-gray);
    }

    .tags-count {
        font-size: 0.8rem;
        color: var(--medium-gray);
        margin-top: 0.5rem;
        text-align: right;
    }

    .tags-count.warning {
        color: var(--error);
    }

    /* Rich Text Editor */
    .editor-container {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
        background: var(--white);
    }

    .editor-toolbar {
        background: var(--light-gray);
        border-bottom: 1px solid var(--border-color);
        padding: 0.75rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        align-items: center;
    }

    .toolbar-btn {
        background: transparent;
        border: 1px solid transparent;
        border-radius: 4px;
        padding: 0.5rem;
        cursor: pointer;
        color: var(--medium-gray);
        transition: all 0.2s ease;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
    }

    .toolbar-btn:hover {
        background: var(--white);
        color: var(--black);
        border-color: var(--border-color);
    }

    .toolbar-btn.active {
        background: var(--accent);
        color: var(--white);
        border-color: var(--accent);
    }

    .toolbar-divider {
        width: 1px;
        height: 20px;
        background: var(--border-color);
        margin: 0 0.5rem;
    }

    .editor-content {
        min-height: 400px;
        padding: 1.5rem;
        font-size: 1.1rem;
        line-height: 1.7;
        color: var(--dark-gray);
        outline: none;
        background: var(--white);
    }

    .editor-content:focus {
        background: var(--white);
    }

    .editor-content h1,
    .editor-content h2,
    .editor-content h3 {
        font-family: 'Playfair Display', serif;
        margin: 1.5rem 0 1rem 0;
        color: var(--black);
    }

    .editor-content h1 {
        font-size: 1.8rem;
        font-weight: 700;
    }

    .editor-content h2 {
        font-size: 1.5rem;
        font-weight: 600;
    }

    .editor-content h3 {
        font-size: 1.25rem;
        font-weight: 600;
    }

    .editor-content blockquote {
        border-left: 4px solid var(--accent);
        padding-left: 1.5rem;
        margin: 1.5rem 0;
        color: var(--medium-gray);
        font-style: italic;
        background: var(--light-gray);
        padding: 1.5rem;
        border-radius: 0 8px 8px 0;
    }

    .editor-content code {
        background: var(--light-gray);
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        color: var(--dark-gray);
    }

    .editor-content pre {
        background: var(--light-gray);
        padding: 1.5rem;
        border-radius: 8px;
        overflow-x: auto;
        margin: 1.5rem 0;
        border-left: 4px solid var(--accent);
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        line-height: 1.5;
        white-space: pre-wrap;
    }

    .editor-content ul,
    .editor-content ol {
        margin: 1rem 0;
        padding-left: 2rem;
    }

    .editor-content li {
        margin-bottom: 0.5rem;
    }

    /* Image Upload - Enhanced */
    .image-upload {
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        padding: 3rem 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: var(--light-gray);
        position: relative;
    }

    .image-upload:hover {
        border-color: var(--accent);
        background: var(--accent-light);
    }

    .image-upload.drag-over {
        border-color: var(--accent);
        background: var(--accent-light);
        transform: scale(1.02);
    }

    .image-upload i {
        font-size: 3rem;
        color: var(--medium-gray);
        margin-bottom: 1rem;
    }

    .image-upload-text {
        color: var(--medium-gray);
        margin-bottom: 0.5rem;
        font-weight: 500;
        font-size: 1.1rem;
    }

    .image-upload-hint {
        font-size: 0.9rem;
        color: var(--medium-gray);
    }

    .image-preview {
        margin-top: 1rem;
        display: none;
        position: relative;
    }

    .image-preview img {
        max-width: 100%;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }

    .image-preview img:hover {
        transform: scale(1.02);
    }

    /* Buttons */
    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
    }

    .btn-primary {
        background: var(--black);
        color: var(--white);
    }

    .btn-primary:hover {
        background: var(--dark-gray);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .btn-secondary {
        background: var(--white);
        color: var(--dark-gray);
        border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
        background: var(--light-gray);
        border-color: var(--medium-gray);
        transform: translateY(-1px);
    }

    .btn-outline {
        background: transparent;
        color: var(--accent);
        border: 1px solid var(--accent);
    }

    .btn-outline:hover {
        background: var(--accent-light);
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid var(--border-color);
    }

    .file-input {
        display: none;
    }

    /* Success Message */
    .success-message {
        background: #f0f9f0;
        color: #166534;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        border: 1px solid #bbf7d0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        animation: slideIn 0.3s ease;
    }

    /* Preview Modal */
    .preview-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        padding: 2rem;
        box-sizing: border-box;
    }

    .preview-modal.active {
        display: flex;
    }

    .preview-container {
        background: var(--white);
        border-radius: 12px;
        width: 100%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
    }

    .preview-header {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        background: var(--white);
        z-index: 10;
    }

    .preview-title {
        font-weight: 600;
        color: var(--black);
        margin: 0;
        font-size: 1.25rem;
    }

    .close-preview {
        background: none;
        border: none;
        font-size: 1.2rem;
        color: var(--medium-gray);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .close-preview:hover {
        background: var(--light-gray);
        color: var(--black);
    }

    .preview-content {
        padding: 2rem;
    }

    .preview-article {
        max-width: 700px;
        margin: 0 auto;
    }

    .preview-article h1 {
        font-family: 'Playfair Display', serif;
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--black);
        margin: 0 0 1rem 0;
        line-height: 1.2;
    }

    .preview-article .meta {
        display: flex;
        align-items: center;
        gap: 1rem;
        color: var(--medium-gray);
        font-size: 0.9rem;
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color);
    }

    .preview-article .featured-image {
        width: 100%;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .preview-article .content {
        font-size: 1.1rem;
        line-height: 1.7;
        color: var(--dark-gray);
    }

    .preview-article .content h1,
    .preview-article .content h2,
    .preview-article .content h3 {
        font-family: 'Playfair Display', serif;
        margin: 2rem 0 1rem 0;
        color: var(--black);
    }

    .preview-article .content h1 { font-size: 1.8rem; }
    .preview-article .content h2 { font-size: 1.5rem; }
    .preview-article .content h3 { font-size: 1.25rem; }

    .preview-article .content blockquote {
        border-left: 4px solid var(--accent);
        padding-left: 1.5rem;
        margin: 1.5rem 0;
        color: var(--medium-gray);
        font-style: italic;
        background: var(--light-gray);
        padding: 1.5rem;
        border-radius: 0 8px 8px 0;
    }

    .preview-article .content code {
        background: var(--light-gray);
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
    }

    .preview-article .content pre {
        background: var(--light-gray);
        padding: 1.5rem;
        border-radius: 8px;
        overflow-x: auto;
        margin: 1.5rem 0;
        border-left: 4px solid var(--accent);
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        line-height: 1.5;
        white-space: pre-wrap;
    }

    .preview-article .tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
    }

    .preview-article .tag {
        background: var(--light-gray);
        color: var(--medium-gray);
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
    }

    /* Toast Notification */
    .toast {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: var(--black);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        z-index: 3000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        font-weight: 500;
        opacity: 0;
        transition: all 0.4s ease;
        max-width: 90vw;
        text-align: center;
    }

    .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }

    .toast.success {
        background: var(--success);
    }

    .toast.error {
        background: var(--error);
    }

    /* Loading State */
    .btn.loading {
        position: relative;
        pointer-events: none;
    }

    .btn.loading::after {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        right: 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Animations */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .create-post-container {
            margin: 60px auto 1rem;
            padding: 0 0.5rem;
        }

        .page-title {
            font-size: 2rem;
        }

        .post-form {
            padding: 1.5rem;
            border-radius: 8px;
        }

        .form-actions {
            flex-direction: column;
        }

        .btn {
            width: 100%;
            justify-content: center;
        }

        .nav-links {
            gap: 1rem;
        }

        .nav-link {
            font-size: 0.9rem;
        }

        .editor-toolbar {
            padding: 0.5rem;
            gap: 0.1rem;
        }

        .toolbar-btn {
            width: 32px;
            height: 32px;
            padding: 0.3rem;
            font-size: 0.8rem;
        }

        .editor-content {
            padding: 1rem;
            min-height: 300px;
        }

        .preview-modal {
            padding: 1rem;
        }

        .preview-container {
            max-height: 95vh;
        }

        .preview-header,
        .preview-content {
            padding: 1rem;
        }

        .preview-article h1 {
            font-size: 2rem;
        }
    }

    @media (max-width: 480px) {
        .page-title {
            font-size: 1.75rem;
        }

        .post-form {
            padding: 1rem;
            border: 1px solid var(--border-color);
            background: var(--white);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .image-upload {
            padding: 2rem 1rem;
        }

        .nav-container {
            padding: 0 0.8rem;
        }

        .logo {
            font-size: 1.3rem;
        }

        .editor-toolbar {
            overflow-x: auto;
            flex-wrap: nowrap;
        }

        .preview-article h1 {
            font-size: 1.75rem;
        }
    }

    /* Fix for horizontal scrolling */
    html, body {
        max-width: 100%;
        overflow-x: hidden;
    }

    * {
        box-sizing: border-box;
    }
</style>

<!-- Top Navigation -->
<nav class="top-navbar">
    <div class="nav-container">
        <a href="{{ url_for('home_page') }}" class="logo">BlogSpace</a>
        <div class="nav-links">
            <a href="{{ url_for('home_page') }}" class="nav-link">Home</a>
            <a href="#" class="nav-link">Explore</a>
            <a href="#" class="nav-link">Bookmarks</a>
            <a href="#" class="nav-link">Profile</a>
        </div>
    </div>
</nav>

<!-- Create Post Container -->
<div class="create-post-container">
    <div class="page-header">
        <h1 class="page-title">Create New Post</h1>
        <p class="page-subtitle">Share your thoughts and ideas with the world</p>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="success-message">
                    <i class="fas fa-check-circle"></i>
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('make_post') }}" enctype="multipart/form-data" class="post-form" id="postForm">
        <!-- Post Title -->
        <div class="form-group">
            <label class="form-label required">Post Title</label>
            <input type="text"
                   class="form-control"
                   name="title"
                   placeholder="Enter a compelling title for your post"
                   required
                   maxlength="120"
                   id="postTitle">
            <div class="char-count" id="titleCount">0/120</div>
        </div>

        <!-- Rich Text Editor -->
        <div class="form-group">
            <label class="form-label required">Post Content</label>
            <div class="editor-container">
                <div class="editor-toolbar" id="toolbar">
                    <button type="button" class="toolbar-btn" data-command="bold" title="Bold">
                        <i class="fas fa-bold"></i>
                    </button>
                    <button type="button" class="toolbar-btn" data-command="italic" title="Italic">
                        <i class="fas fa-italic"></i>
                    </button>
                    <button type="button" class="toolbar-btn" data-command="underline" title="Underline">
                        <i class="fas fa-underline"></i>
                    </button>
                    <div class="toolbar-divider"></div>
                    <button type="button" class="toolbar-btn" data-command="formatBlock" data-value="H1" title="Heading 1">
                        H1
                    </button>
                    <button type="button" class="toolbar-btn" data-command="formatBlock" data-value="H2" title="Heading 2">
                        H2
                    </button>
                    <button type="button" class="toolbar-btn" data-command="formatBlock" data-value="H3" title="Heading 3">
                        H3
                    </button>
                    <div class="toolbar-divider"></div>
                    <button type="button" class="toolbar-btn" data-command="insertUnorderedList" title="Bullet List">
                        <i class="fas fa-list-ul"></i>
                    </button>
                    <button type="button" class="toolbar-btn" data-command="insertOrderedList" title="Numbered List">
                        <i class="fas fa-list-ol"></i>
                    </button>
                    <div class="toolbar-divider"></div>
                    <button type="button" class="toolbar-btn" data-command="createLink" title="Insert Link">
                        <i class="fas fa-link"></i>
                    </button>
                    <button type="button" class="toolbar-btn" data-command="quote" title="Quote">
                        <i class="fas fa-quote-right"></i>
                    </button>
                    <button type="button" class="toolbar-btn" data-command="code" title="Code Block">
                        <i class="fas fa-code"></i>
                    </button>
                </div>
                <div class="editor-content" id="editor" contenteditable="true">
                    <p>Start writing your amazing content here... ✨</p>
                </div>
            </div>
            <input type="hidden" name="content" id="postContent">
            <div class="char-count" id="contentCount">0/10000</div>
            <div class="help-text">Use the toolbar above to format your content</div>
        </div>

        <!-- Featured Image -->
        <div class="form-group">
            <label class="form-label">Featured Image</label>
            <div class="image-upload" id="imageUpload">
                <i class="fas fa-cloud-upload-alt"></i>
                <div class="image-upload-text">Click to upload or drag and drop</div>
                <div class="image-upload-hint">JPG, PNG • Max 5MB</div>
                <input type="file"
                       id="imageInput"
                       name="featured_image"
                       class="file-input"
                       accept="image/*">
            </div>
            <div class="image-preview" id="imagePreview">
                <img id="previewImage" src="" alt="Preview">
                <div style="margin-top: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="removeImagePreview()">
                        <i class="fas fa-trash"></i>
                        Remove Image
                    </button>
                </div>
            </div>
        </div>

        <!-- Category -->
        <div class="form-group">
            <label class="form-label">Category</label>
            <select class="form-control" name="category" id="postCategory">
                <option value="">Select a category</option>
                <option value="technology">Technology</option>
                <option value="programming">Programming</option>
                <option value="design">Design</option>
                <option value="business">Business</option>
                <option value="lifestyle">Lifestyle</option>
                <option value="health">Health & Wellness</option>
                <option value="travel">Travel</option>
                <option value="education">Education</option>
            </select>
            <div class="help-text">Choose a category that best fits your post</div>
        </div>

        <!-- Enhanced Tags Input -->
        <div class="form-group">
            <label class="form-label">Tags</label>
            <div class="tags-input-container" id="tagsContainer">
                <div class="tags-display" id="tagsDisplay"></div>
                <input type="text"
                       class="form-control"
                       id="postTagsInput"
                       placeholder="Type a tag and press Enter, comma, or space..."
                       maxlength="30">
                <input type="hidden" name="tags" id="postTags">
            </div>
            <div class="help-text">Add relevant tags to help readers discover your post</div>
            <div class="tags-count" id="tagsCount">0/10 tags</div>
        </div>

        <!-- Excerpt -->
        <div class="form-group">
            <label class="form-label">Excerpt</label>
            <textarea class="form-control"
                      name="excerpt"
                      placeholder="Brief description of your post (optional)"
                      maxlength="200"
                      id="postExcerpt"></textarea>
            <div class="char-count" id="excerptCount">0/200</div>
            <div class="help-text">A short summary that appears in post listings</div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="window.location.href='{{ url_for('home_page') }}'">
                <i class="fas fa-times"></i>
                Cancel
            </button>
            <button type="button" class="btn btn-outline" id="previewBtn">
                <i class="fas fa-eye"></i>
                Preview
            </button>
            <button type="submit" class="btn btn-primary" id="publishBtn">
                <i class="fas fa-paper-plane"></i>
                Publish Post
            </button>
        </div>
    </form>
</div>

<!-- Preview Modal -->
<div class="preview-modal" id="previewModal">
    <div class="preview-container">
        <div class="preview-header">
            <h3 class="preview-title">Post Preview</h3>
            <button class="close-preview" id="closePreview">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="preview-content">
            <article class="preview-article" id="previewArticle">
                <!-- Preview content will be generated here -->
            </article>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elements
        const editor = document.getElementById('editor');
        const postTitle = document.getElementById('postTitle');
        const postContent = document.getElementById('postContent');
        const imageUpload = document.getElementById('imageUpload');
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        const previewImage = document.getElementById('previewImage');
        const toolbar = document.getElementById('toolbar');
        const previewBtn = document.getElementById('previewBtn');
        const publishBtn = document.getElementById('publishBtn');
        const postForm = document.getElementById('postForm');
        const previewModal = document.getElementById('previewModal');
        const closePreview = document.getElementById('closePreview');
        const previewArticle = document.getElementById('previewArticle');

        // Character counters
        const titleCount = document.getElementById('titleCount');
        const contentCount = document.getElementById('contentCount');
        const excerptCount = document.getElementById('excerptCount');

        // Initialize
        initCharacterCounters();
        initRichTextEditor();
        initImageUpload();
        initPreviewFeature();
        initTagsInput(); // Initialize the enhanced tags input

        // Enhanced Tags Input Functionality
        function initTagsInput() {
            const tagsInput = document.getElementById('postTagsInput');
            const tagsDisplay = document.getElementById('tagsDisplay');
            const tagsHidden = document.getElementById('postTags');
            const tagsCount = document.getElementById('tagsCount');
            const tagsContainer = document.getElementById('tagsContainer');

            let tags = [];
            const MAX_TAGS = 10;

            function updateTagsDisplay() {
                tagsDisplay.innerHTML = '';
                tags.forEach((tag, index) => {
                    const tagElement = document.createElement('div');
                    tagElement.className = 'tag-item';
                    tagElement.innerHTML = `
                        ${escapeHtml(tag)}
                        <button type="button" class="tag-remove" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    tagsDisplay.appendChild(tagElement);
                });

                tagsHidden.value = tags.join(',');
                tagsCount.textContent = `${tags.length}/${MAX_TAGS} tags`;

                if (tags.length >= MAX_TAGS) {
                    tagsCount.classList.add('warning');
                    tagsInput.placeholder = 'Maximum tags reached';
                    tagsInput.disabled = true;
                } else {
                    tagsCount.classList.remove('warning');
                    tagsInput.placeholder = 'Type a tag and press Enter, comma, or space...';
                    tagsInput.disabled = false;
                }
            }

            function addTag(tag) {
                const cleanTag = tag.trim().toLowerCase();

                // Validate tag
                if (!cleanTag) return false;
                if (cleanTag.length < 2) {
                    showToast('Tags must be at least 2 characters long', 'error');
                    return false;
                }
                if (cleanTag.length > 30) {
                    showToast('Tags cannot exceed 30 characters', 'error');
                    return false;
                }
                if (tags.includes(cleanTag)) {
                    showToast('Tag already added', 'error');
                    return false;
                }
                if (tags.length >= MAX_TAGS) {
                    showToast(`Maximum ${MAX_TAGS} tags allowed`, 'error');
                    return false;
                }

                tags.push(cleanTag);
                updateTagsDisplay();
                showToast(`Tag "${cleanTag}" added`, 'success');
                return true;
            }

            function removeTag(index) {
                const removedTag = tags[index];
                tags.splice(index, 1);
                updateTagsDisplay();
                showToast(`Tag "${removedTag}" removed`, 'success');
            }

            // Event listeners for tags input
            tagsInput.addEventListener('keydown', function(e) {
                if ((e.key === 'Enter' || e.key === ',' || e.key === ' ') && this.value.trim()) {
                    e.preventDefault();
                    if (addTag(this.value)) {
                        this.value = '';
                    }
                }

                // Backspace to remove last tag
                if (e.key === 'Backspace' && this.value === '' && tags.length > 0) {
                    removeTag(tags.length - 1);
                }
            });

            tagsInput.addEventListener('blur', function() {
                if (this.value.trim()) {
                    if (addTag(this.value)) {
                        this.value = '';
                    }
                }
            });

            // Click on container to focus input
            tagsContainer.addEventListener('click', function() {
                tagsInput.focus();
            });

            // Remove tag when X is clicked
            tagsDisplay.addEventListener('click', function(e) {
                if (e.target.closest('.tag-remove')) {
                    const index = parseInt(e.target.closest('.tag-remove').dataset.index);
                    removeTag(index);
                }
            });

            // Initialize with any existing tags from form submission errors
            const existingTags = tagsHidden.value;
            if (existingTags) {
                tags = existingTags.split(',').filter(tag => tag.trim());
                updateTagsDisplay();
            }
        }

        // Character Counters
        function initCharacterCounters() {
            const postExcerpt = document.getElementById('postExcerpt');

            updateCounter(titleCount, postTitle.value.length, 120);
            updateCounter(contentCount, editor.textContent.length, 10000);
            updateCounter(excerptCount, postExcerpt.value.length, 200);

            postTitle.addEventListener('input', () => {
                updateCounter(titleCount, postTitle.value.length, 120);
            });

            editor.addEventListener('input', () => {
                updateCounter(contentCount, editor.textContent.length, 10000);
            });

            postExcerpt.addEventListener('input', () => {
                updateCounter(excerptCount, postExcerpt.value.length, 200);
            });
        }

        function updateCounter(counter, current, max) {
            counter.textContent = `${current}/${max}`;
            if (current > max * 0.9) {
                counter.style.color = '#ef4444';
            } else if (current > max * 0.75) {
                counter.style.color = '#f59e0b';
            } else {
                counter.style.color = 'var(--medium-gray)';
            }
        }

        // Rich Text Editor
        function initRichTextEditor() {
            // Toolbar functionality
            toolbar.addEventListener('click', function(e) {
                if (e.target.closest('.toolbar-btn')) {
                    const button = e.target.closest('.toolbar-btn');
                    const command = button.dataset.command;
                    const value = button.dataset.value;

                    e.preventDefault();
                    editor.focus();

                    if (command === 'code') {
                        insertCodeBlock();
                    } else if (command === 'quote') {
                        insertQuote();
                    } else if (command === 'createLink') {
                        insertLink();
                    } else {
                        document.execCommand(command, false, value);
                    }

                    // Update active state for format buttons
                    if (['bold', 'italic', 'underline'].includes(command)) {
                        button.classList.toggle('active');
                    }
                }
            });

            // Update hidden content field before form submission
            postForm.addEventListener('submit', function() {
                postContent.value = editor.innerHTML;

                // Show loading state
                publishBtn.classList.add('loading');
                publishBtn.disabled = true;
                publishBtn.innerHTML = '<i class="fas fa-spinner"></i> Publishing...';
            });
        }

        function insertCodeBlock() {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);

                // Create a pre element with code inside
                const pre = document.createElement('pre');
                const code = document.createElement('code');

                // If there's selected text, use it as the code content
                if (!selection.toString().trim()) {
                    code.textContent = '// Write your code here\nfunction example() {\n    return "Hello World!";\n}';
                } else {
                    code.textContent = selection.toString();
                }

                pre.appendChild(code);

                // Insert the code block
                range.deleteContents();
                range.insertNode(pre);

                // Move cursor inside the code block
                const newRange = document.createRange();
                newRange.setStart(code, 0);
                newRange.collapse(true);
                selection.removeAllRanges();
                selection.addRange(newRange);
            }
        }

        function insertQuote() {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const blockquote = document.createElement('blockquote');

                if (!selection.toString().trim()) {
                    blockquote.textContent = 'Write your quote here...';
                } else {
                    blockquote.textContent = selection.toString();
                    range.deleteContents();
                }

                range.insertNode(blockquote);

                // Move cursor after the quote
                const newRange = document.createRange();
                newRange.setStartAfter(blockquote);
                newRange.collapse(true);
                selection.removeAllRanges();
                selection.addRange(newRange);
            }
        }

        function insertLink() {
            const url = prompt('Enter URL:');
            if (url) {
                document.execCommand('createLink', false, url);
            }
        }

        // Image Upload with Drag & Drop
        function initImageUpload() {
            // Click to upload
            imageUpload.addEventListener('click', function(e) {
                if (e.target.type !== 'file') {
                    imageInput.click();
                }
            });

            // Drag and drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                imageUpload.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                imageUpload.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                imageUpload.addEventListener(eventName, unhighlight, false);
            });

            function highlight() {
                imageUpload.classList.add('drag-over');
            }

            function unhighlight() {
                imageUpload.classList.remove('drag-over');
            }

            imageUpload.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length > 0) {
                    handleImageUpload(files[0]);
                }
            }

            imageInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    handleImageUpload(this.files[0]);
                }
            });
        }

        function handleImageUpload(file) {
            // Validate file type
            if (!file.type.match('image/jpeg') && !file.type.match('image/png')) {
                showToast('Please upload JPG or PNG images only', 'error');
                return;
            }

            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('Image size should be less than 5MB', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                imagePreview.style.display = 'block';
                imageUpload.style.display = 'none';
                showToast('Image uploaded successfully!', 'success');
            };
            reader.readAsDataURL(file);
        }

        // Preview Feature
        function initPreviewFeature() {
            previewBtn.addEventListener('click', showPreview);
            closePreview.addEventListener('click', closePreviewModal);

            // Close preview when clicking outside
            previewModal.addEventListener('click', function(e) {
                if (e.target === previewModal) {
                    closePreviewModal();
                }
            });

            // Close preview with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && previewModal.classList.contains('active')) {
                    closePreviewModal();
                }
            });
        }

        function showPreview() {
            const title = postTitle.value.trim();
            const content = editor.innerHTML;
            const excerpt = document.getElementById('postExcerpt').value;
            const category = document.getElementById('postCategory').value;
            const tags = document.getElementById('postTags').value;
            const hasImage = imagePreview.style.display !== 'none';

            if (!title) {
                showToast('Please add a title to preview your post', 'error');
                postTitle.focus();
                return;
            }

            if (editor.textContent.trim().length < 10) {
                showToast('Please add some content to preview your post', 'error');
                editor.focus();
                return;
            }

            // Generate preview content
            let previewHTML = `
                <h1>${escapeHtml(title)}</h1>

                <div class="meta">
                    <span><i class="fas fa-user"></i> By You</span>
                    <span>•</span>
                    <span><i class="fas fa-calendar"></i> ${new Date().toLocaleDateString()}</span>
                    <span>•</span>
                    <span><i class="fas fa-clock"></i> ${calculateReadingTime()} min read</span>
                    ${category ? `<span>•</span><span><i class="fas fa-folder"></i> ${escapeHtml(category)}</span>` : ''}
                </div>
            `;

            if (hasImage) {
                previewHTML += `<img src="${previewImage.src}" alt="${escapeHtml(title)}" class="featured-image">`;
            }

            if (excerpt) {
                previewHTML += `<div style="font-style: italic; color: var(--medium-gray); margin-bottom: 2rem; padding: 1rem; background: var(--light-gray); border-radius: 6px;">${escapeHtml(excerpt)}</div>`;
            }

            previewHTML += `<div class="content">${content}</div>`;

            if (tags) {
                const tagArray = tags.split(',').filter(tag => tag.trim());
                if (tagArray.length > 0) {
                    previewHTML += `
                        <div class="tags">
                            <strong>Tags:</strong>
                            ${tagArray.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
                        </div>
                    `;
                }
            }

            previewArticle.innerHTML = previewHTML;
            previewModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closePreviewModal() {
            previewModal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function calculateReadingTime() {
            const text = editor.textContent || editor.innerText;
            const words = text.trim().split(/\s+/).length;
            return Math.max(1, Math.ceil(words / 200));
        }

        // Toast Notification
        function showToast(message, type = '') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 400);
            }, 3000);
        }

        // Add subtle animation to form
        const form = document.querySelector('.post-form');
        form.style.opacity = '0';
        form.style.transform = 'translateY(20px)';

        setTimeout(() => {
            form.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            form.style.opacity = '1';
            form.style.transform = 'translateY(0)';
        }, 100);
    });

    // Image preview functionality
    function removeImagePreview() {
        const imagePreview = document.getElementById('imagePreview');
        const imageUpload = document.getElementById('imageUpload');
        const imageInput = document.getElementById('imageInput');

        imagePreview.style.display = 'none';
        imageUpload.style.display = 'block';
        imageInput.value = '';
    }
</script>
{% endblock %}